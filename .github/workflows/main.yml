name: Build libproot.so for Android

on:
  workflow_dispatch:
  push:
    paths:
      - '**.sh'
      - '**.c'
      - '**.h'
      - '**.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git wget python3

      - name: Clone proot-me/proot
        run: |
          git clone https://github.com/proot-me/proot.git proot-upstream
          # Optionally checkout a specific commit/tag if you want

      - name: Prepare build-proot-android scripts
        run: |
          git clone https://github.com/green-green-avk/build-proot-android.git
          # Replace the proot sources with fresh clone
          rm -rf build-proot-android/proot
          cp -r proot-upstream build-proot-android/proot

      - name: Build multi-ABI, multi-API libproot.so
        run: |
          cd build-proot-android
          export ANDROID_NDK_HOME="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          for abi in armeabi-v7a arm64-v8a x86 x86_64; do
            for api in 28 29 30; do
              API=$api scripts/build.sh $abi
              case $api in
                28)
                  mv libs/$abi/libproot.so libs/$abi/lib_proot.so
                  ;;
                29)
                  mv libs/$abi/libproot.so libs/$abi/lib_proot.a10.so
                  ;;
                30)
                  mv libs/$abi/libproot.so libs/$abi/lib_proot.a11.so
                  ;;
              esac
            done
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: libproot-android-all
          path: build-proot-android/libs/
