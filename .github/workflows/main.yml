name: Build Static PROOT for Android arm64

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK_HOME: ${{ github.workspace }}/android-ndk

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Install build essentials
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget curl unzip

      - name: Download Android NDK r23b
        run: |
          NDK_VERSION="android-ndk-r23b"
          NDK_ZIP="${NDK_VERSION}-linux.zip"
          NDK_URL="https://dl.google.com/android/repository/${NDK_ZIP}"
          wget -q "$NDK_URL"
          unzip -q "$NDK_ZIP"
          mv "$NDK_VERSION" "$ANDROID_NDK_HOME"

      - name: Make build.sh executable
        run: chmod +x scripts/build.sh

      - name: Build static libproot.so for Android arm64 (from proot-me)
        run: |
          export ANDROID_NDK_HOME="${ANDROID_NDK_HOME}"
          export PATH="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          export LINK_STATIC=1
          # Override PRoot source to official proot-me
          export P_ROOT_REPO_URL="https://github.com/proot-me/proot.git"
          export P_ROOT_REPO_REV="master"   # Change to a tag/commit if desired
          export API=28    # Change to desired API level
          scripts/build.sh arm64-v8a

      - name: Upload static libproot.so artifact
        uses: actions/upload-artifact@v4
        with:
          name: libproot-so-arm64-static
          path: libs/arm64-v8a/libproot.so
