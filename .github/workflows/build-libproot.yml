name: Build libproot.so ARM64

on:
  workflow_dispatch:

jobs:
  build-proot:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout scripts
      uses: actions/checkout@v4

    - name: Create build scripts
      run: |
        mkdir build
        cat > build/Dockerfile << 'EOF'
        FROM messense/musl-cross:aarch64

        RUN apk add --no-cache \
            build-base git automake autoconf libtool bash patch

        WORKDIR /build
        COPY build-proot.sh /build/build-proot.sh
        COPY proot-android.patch /build/proot-android.patch

        ENTRYPOINT ["/build/build-proot.sh"]
        EOF

        cat > build/build-proot.sh << 'EOF'
        #!/bin/bash
        set -e

        export TARGET=aarch64-linux-musl
        export CC=${TARGET}-gcc
        export AR=${TARGET}-ar
        export RANLIB=${TARGET}-ranlib
        export STRIP=${TARGET}-strip

        echo "Cloning PRoot…"
        git clone https://github.com/proot-me/proot.git
        cd proot

        echo "Applying Android patch…"
        patch -p1 < /build/proot-android.patch

        echo "Building PRoot static libs…"
        make -j$(nproc) \
          CC="$CC -static -fPIC" \
          LD="$CC -static" \
          CFLAGS="-O2 -static -fPIC -DPROOT_NO_SECCOMP" \
          LDFLAGS="-static"

        echo "Creating libproot.so…"
        ${CC} -shared -static -o libproot.so \
          -Wl,--whole-archive src/loader/libvfs.a src/extension/*.a \
          -Wl,--no-whole-archive -fPIC

        $STRIP libproot.so

        mkdir -p /out
        cp libproot.so /out/
        EOF

        cat > build/proot-android.patch << 'EOF'
        diff --git a/src/loader/loader.c b/src/loader/loader.c
        index 3a12cd9..abcd111 100644
        --- a/src/loader/loader.c
        +++ b/src/loader/loader.c
        @@ -210,7 +210,7 @@ static const char *const system_paths[] = {
        -    "/lib",
        +    "/system/lib",
        -    "/usr/lib",
        +    "/system/lib64",
             NULL,
        };
        EOF

        chmod +x build/build-proot.sh

    - name: Build Docker image
      run: docker build -t proot-builder ./build

    - name: Run build
      run: |
        mkdir output
        docker run --rm -v ${{ github.workspace }}/output:/out proot-builder

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: libproot-arm64
        path: output/libproot.so
